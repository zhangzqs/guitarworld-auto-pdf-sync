name: Download PDFs

on:
  workflow_dispatch:
    inputs:
      cookies:
        description: 'Guitar World Cookies (å¿…é¡»åŒ…å« XSRF-TOKEN å’Œ guitarworld_ses)'
        required: true
        type: string
      output_dir:
        description: 'è¾“å‡ºç›®å½•åç§°'
        required: false
        default: 'pdfs'
        type: string
      concurrency:
        description: 'å¹¶å‘æ•°'
        required: false
        default: '3'
        type: string

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build
        run: go build -o guitarworld-sync ./cmd/guitarworld-sync

      - name: Download PDFs
        env:
          GUITARWORLD_COOKIES: ${{ inputs.cookies }}
        run: |
          ./guitarworld-sync -output ${{ inputs.output_dir }} -concurrency ${{ inputs.concurrency }}

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: guitarworld-pdfs-${{ github.run_number }}
          path: ${{ inputs.output_dir }}/
          retention-days: 7
          compression-level: 9

      - name: Generate summary
        run: |
          echo "## ä¸‹è½½å®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- æ€»æ–‡ä»¶æ•°: $(find ${{ inputs.output_dir }} -name "*.pdf" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- æ€»å¤§å°: $(du -sh ${{ inputs.output_dir }} | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find ${{ inputs.output_dir }} -name "*.pdf" | head -20 >> $GITHUB_STEP_SUMMARY
          total=$(find ${{ inputs.output_dir }} -name "*.pdf" | wc -l)
          if [ $total -gt 20 ]; then
            echo "... å’Œå…¶ä»– $((total - 20)) ä¸ªæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ PDF æ–‡ä»¶å·²ä¸Šä¼ ä¸º Artifactï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
